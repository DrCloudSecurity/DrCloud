This runbook collects findings from Security Hub.\
A list of critical/high vulnerabilities are compiled.\
The output can be sent to Slack via webhook or email via SNS.

### Future imporovements can include
- GuardDuty
- Inspector
- Config
- Adjust the schedule
- Remediation of specific vulnerabilities


### Build Lambda function
- Create the Lambda function
- runtime: python
- add the logic
```
import boto3
import json
import os
import requests
from datetime import datetime, timedelta

# initialize clients
# first client is Security Hub
securityhub = boto3.client('securityhub')
sns = boto3.client('sns')


# env vars. remember to set in lambfa function.
SLACK_WEBHOOK_URL = os.environ['SLACK_WEBHOOK_URL']
SNS_TOPIC_ARN = os.environ['SNS_TOPIC_ARN']


# grok findings from sec hub
# limit to: critical, high
def get_vulnerability_findings():
    findings = []
    paginator = securityhub.get_paginator('get_findings')
    today = datetime.utcnow() - timedelta(days=1)

    filters = {
        'SeverityLabel': [{'Value': 'CRITICAL', 'Comparison': 'EQUALS'}, {'Value': 'HIGH', 'Comparison': 'EQUALS'}],
        'CreatedAt': [{'Start': today.strftime('%Y-%m-%dT00:00:00Z'), 'End': datetime.utcnow().strftime('%Y-%m-%dT23:59:59Z')}]
    }

    for page in paginator.paginate(Filters=filters):
        findings.extend(page['Findings'])

    return findings


# format for slack/email
def format_summary(findings):
    if not findings:
        return "No critical or high vulnerabilities found."
    
    summary = f"*{len(findings)} Critical/High Vulnerabilities Detected Today:*\n"
    for finding in findings[:10]:  # Limit output to 10 findings for brevity
        summary += f"- *{finding['Title']}* - {finding['Severity']['Label']}\n  {finding['Resources'][0]['Id']}\n"

    if len(findings) > 10:
        summary += f"\n...and {len(findings) - 10} more issues.\n"

    return summary


# send output to slack
def send_to_slack(message):
    payload = {"text": message}
    requests.post(SLACK_WEBHOOK_URL, json=payload)


# send output to sns
def send_to_sns(message):
    sns.publish(TopicArn=SNS_TOPIC_ARN, Message=message, Subject="Daily Vulnerability Summary")


# lambda handler
def lambda_handler(event, context):
    findings = get_vulnerability_findings()
    summary = format_summary(findings)


    # send summary to slack and sns
    send_to_slack(summary)
    send_to_sns(summary)

    # exit gracefully
    print("Summary sent successfully.")
```

![Image](https://github.com/user-attachments/assets/a1a17366-0ff9-4d18-8853-2a5fb2ef1c07)


### Set up Slack webhook
- Go to Slack --> incoming webhooks
- Create a new incoming webhook
- Select the channel (#vulnerability-report)
- Copy the webhook url. It will look something like "https://hooks.slack.com/services/EK37DK".
- For help see: https://api.slack.com/messaging/webhooks
- 
### Configure email notifications via SNS
- Go to SNS, create topic
- type: standard
- Create a subscription, confirm it
![Image](https://github.com/user-attachments/assets/3ebac012-d7e4-45eb-bf2a-26bbae0673b7)


### Add environment variables to the function
- SLACK_WEBHOOK_URL = https://hooks.slack.com/services/EK37DK
- SNS_TOPIC_ARN = VulnerabilityReport
